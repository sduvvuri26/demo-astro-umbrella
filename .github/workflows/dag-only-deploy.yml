name: DAG-only deploy from umbrella repo

on:
  workflow_dispatch: {}
  
  # Optional: Auto-sync every 30 minutes (remove comment to enable)
  # schedule:
  #   - cron: '*/30 * * * *'

env:
  ASTRO_API_TOKEN: ${{ secrets.ASTRO_API_TOKEN }}
  ASTRO_API_DOMAIN: ${{ secrets.ASTRO_API_DOMAIN }}
  ASTRO_DEPLOYMENT_ID: ${{ secrets.ASTRO_DEPLOYMENT_ID }}

jobs:
  deploy-dags:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout umbrella repo (Astro project)
        uses: actions/checkout@v4

      - name: Clean existing dags directory
        run: |
          rm -rf dags
          mkdir -p dags/team-a dags/team-b

      - name: Clone demo-repo-a (DAGs 1 & 2)
        run: |
          git clone https://github.com/${{ github.repository_owner }}/demo-repo-a.git repo-a

      - name: Clone demo-repo-b (DAGs 3 & 4)
        run: |
          git clone https://github.com/${{ github.repository_owner }}/demo-repo-b.git repo-b

      - name: Copy DAGs from A & B into umbrella dags/
        run: |
          # Copy repo-a DAGs to team-a folder
          if [ -d "repo-a/dags" ]; then
            cp -r repo-a/dags/* dags/team-a/ || true
            echo "‚úÖ Copied DAGs from repo-a to dags/team-a/"
          else
            echo "‚ö†Ô∏è  No dags folder found in repo-a"
          fi

          # Copy repo-b DAGs to team-b folder
          if [ -d "repo-b/dags" ]; then
            cp -r repo-b/dags/* dags/team-b/ || true
            echo "‚úÖ Copied DAGs from repo-b to dags/team-b/"
          else
            echo "‚ö†Ô∏è  No dags folder found in repo-b"
          fi

          echo ""
          echo "üì¶ Final DAG structure in umbrella repo:"
          ls -R dags || true

      - name: Install Astro CLI
        run: |
          curl -sSL https://install.astronomer.io | sudo bash -s

      - name: Deploy to Astronomer
        run: |
          astro version
          astro login "$ASTRO_API_DOMAIN" --token-login "$ASTRO_API_TOKEN"
          astro deploy "$ASTRO_DEPLOYMENT_ID" --dags --force --wait 600
        env:
          ASTRO_API_TOKEN: ${{ secrets.ASTRO_API_TOKEN }}
          ASTRO_API_DOMAIN: ${{ secrets.ASTRO_API_DOMAIN }}
          ASTRO_DEPLOYMENT_ID: ${{ secrets.ASTRO_DEPLOYMENT_ID }}

      - name: Deployment Summary
        if: always()
        run: |
          echo ""
          echo "üöÄ Deployment Status:"
          echo "   Deployment ID: $ASTRO_DEPLOYMENT_ID"
          echo "   Domain: $ASTRO_API_DOMAIN"
          echo ""
          echo "üìÇ Deployed DAGs:"
          find dags -name "*.py" -type f || true
