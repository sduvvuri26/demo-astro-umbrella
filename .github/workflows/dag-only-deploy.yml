name: DAG-only deploy from umbrella repo

on:
  workflow_dispatch: {}

env:
  ASTRO_API_TOKEN: ${{ secrets.ASTRO_API_TOKEN }}
  ASTRO_API_DOMAIN: ${{ secrets.ASTRO_API_DOMAIN }}
  ASTRO_DEPLOYMENT_ID: ${{ secrets.ASTRO_DEPLOYMENT_ID }}

jobs:
  deploy-dags:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout umbrella repo (Astro project)
        uses: actions/checkout@v4

      - name: Clean existing dags directory
        run: |
          rm -rf dags
          mkdir -p dags

      - name: Clone demo-repo-a (DAGs 1 & 2)
        run: |
          git clone https://github.com/${{ github.repository_owner }}/demo-repo-a.git repo-a

      - name: Clone demo-repo-b (DAGs 3 & 4)
        run: |
          git clone https://github.com/${{ github.repository_owner }}/demo-repo-b.git repo-b

      - name: Copy DAGs from A & B into umbrella dags/
        run: |
          if [ -d "repo-a/dags" ]; then
            cp repo-a/dags/*.py dags/ || true
          fi

          if [ -d "repo-b/dags" ]; then
            cp repo-b/dags/*.py dags/ || true
          fi

          echo "DAGs in umbrella repo:"
          ls -R dags || true

      - name: Install Astro CLI
        run: |
          curl -sSL https://install.astronomer.io | bash
          echo "$HOME/.astro/bin" >> $GITHUB_PATH

      - name: Astro login
        run: |
          astro version
          astro login "$ASTRO_API_DOMAIN" --token "$ASTRO_API_TOKEN"

      - name: DAG-only deploy via Astro CLI
        run: |
          astro deploy "$ASTRO_DEPLOYMENT_ID" --dags --force --wait 600
